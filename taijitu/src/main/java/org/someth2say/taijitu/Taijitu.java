package org.someth2say.taijitu;

import org.apache.commons.configuration2.ImmutableHierarchicalConfiguration;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.someth2say.taijitu.compare.result.ComparisonResult;
import org.someth2say.taijitu.config.impl.TaijituCfg;
import org.someth2say.taijitu.config.interfaces.IComparisonCfg;
import org.someth2say.taijitu.config.interfaces.IPluginCfg;
import org.someth2say.taijitu.config.interfaces.ITaijituCfg;
import org.someth2say.taijitu.plugins.TaijituPlugin;
import org.someth2say.taijitu.registry.*;
import org.someth2say.taijitu.source.query.ConnectionManager;
import org.someth2say.taijitu.util.FileUtil;

import java.util.List;
import java.util.concurrent.*;

import static org.someth2say.taijitu.config.DefaultConfig.DEFAULT_CONFIG_FILE;

/**
 * @author Jordi Sola
 */
final class Taijitu {

    private static final Logger logger = LoggerFactory.getLogger(Taijitu.class);

    private static ITaijituCfg configFromApache(final ImmutableHierarchicalConfiguration properties) {
        return TaijituCfg.fromApacheConfig(properties);
    }


    private static ITaijituCfg configFromFile(final String fileName) throws TaijituException {
        return TaijituCfg.fromFile(fileName);
    }

    private static void performSetup(final ITaijituCfg config) throws TaijituException {
        try {
            setupRegistries(config);
        } catch (Exception e) {
            throw new TaijituException("Unable to prepare Taijitu.", e);
        }
    }

    //TODO: This registry stuff may be moved to a IC context (Weld?)
    private static void setupRegistries(final ITaijituCfg config) {
        if (config.isUseScanClassPath()) {
            PluginRegistry.scanClassPath();
            StreamEqualityRegistry.scanClassPath();
            ValueEqualityRegistry.scanClassPath();
            SourceRegistry.scanClassPath();
            MapperRegistry.scanClassPath();
        } else {
            PluginRegistry.useDefaults();
            StreamEqualityRegistry.useDefaults();
            ValueEqualityRegistry.useDefaults();
            SourceRegistry.useDefaults();
            MapperRegistry.useDefaults();
        }
    }

    public static void main(final String[] args) {
        if (args.length != 1) {
            FileUtil.dumpResource("usage-taijitu.txt");
        } else {
            // run comparison with default values
            try {
                Taijitu.compare(args[0]);
            } catch (TaijituException e) {
                logger.error("Unable to start: ", e);
            }
        }
    }

    public static ComparisonResult[] compare() throws TaijituException {
        return compare(DEFAULT_CONFIG_FILE);
    }

    private static ComparisonResult[] compare(final String fileName) throws TaijituException {
        return compare(configFromFile(fileName));
    }


    public static ComparisonResult[] compare(final ImmutableHierarchicalConfiguration properties) throws TaijituException {
        return compare(configFromApache(properties));
    }


    public static ComparisonResult[] compare(final ITaijituCfg config) throws TaijituException {
        logger.info("Start comparisons.");
        performSetup(config);

        List<IComparisonCfg> comparisons = config.getComparisons();

        startPlugins(config);

        final CompletionService<ComparisonResult> completionService = runComparisons(config);

        // Collect results
        final ComparisonResult[] result = getComparisonResults(completionService, comparisons);

        endPlugins(config);

        // Close all open connections generated by comparison queries:
        closeDataSources();

        return result;

    }

    private static CompletionService<ComparisonResult> runComparisons(final ITaijituCfg config) {
        final ExecutorService executorService = Executors.newFixedThreadPool(config.getThreads());
        CompletionService<ComparisonResult> completionService = new ExecutorCompletionService<>(executorService);

        config.getComparisons().forEach(comparison -> completionService.submit(new TaijituRunner(comparison)));

        executorService.shutdown();

        return completionService;
    }


    private static void endPlugins(ITaijituCfg config) {
        List<IPluginCfg> allPluginsConfig = config.getPluginConfigs();
        for (IPluginCfg pluginConfigIface : allPluginsConfig) {
            TaijituPlugin plugin = PluginRegistry.getPlugin(pluginConfigIface.getName());
            plugin.end(pluginConfigIface);
        }
    }

    private static void startPlugins(ITaijituCfg config) {
        List<IPluginCfg> allPluginsConfig = config.getPluginConfigs();
        for (IPluginCfg pluginCfg : allPluginsConfig) {
            TaijituPlugin plugin = PluginRegistry.getPlugin(pluginCfg.getName());
            plugin.start(pluginCfg);
        }
    }

    private static ComparisonResult[] getComparisonResults(CompletionService<ComparisonResult> completionService,
                                                           List<IComparisonCfg> iComparisonCfgs) {
        final ComparisonResult[] result = new ComparisonResult[iComparisonCfgs.size()];
        for (int i = 0; i < iComparisonCfgs.size(); i++) {
            try {
                Future<ComparisonResult> future = completionService.take();
                try {
                    result[i] = future.get();
                } catch (ExecutionException e) {
                    logger.error("Unable to obtain comparison result.", e);
                    result[i] = null;
                }
            } catch (InterruptedException e) {
                logger.error("Unable to obtain comparison result.", e);
                result[i] = null;
            }
        }
        return result;
    }

    private static void closeDataSources() {
        ConnectionManager.closeAllDataSources();
    }

}
